<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis History - Tree Health Detection System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #198754;
            --primary-dark: #157347;
            --secondary-color: #6c757d;
            --accent-color: #ffc107;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --info-color: #0dcaf0;
            --light-bg: #f8f9fa;
            --dark-bg: #212529;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }

        .app-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 30px 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            
        }

        .app-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.1;
            z-index: 0;
        }

        .app-header > .container {
            position: relative;
            z-index: 1;
        }

        .app-header h1 {
            font-weight: 700;
            letter-spacing: -0.5px;
            position: relative;
            z-index: 1;
        }

        .control-panel {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .filter-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .filter-buttons .btn {
            border-radius: 25px;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            margin: 0.25rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .filter-buttons .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .filter-buttons .btn:hover::before {
            left: 100%;
        }

        .filter-buttons .btn.active {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .bulk-actions {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            display: none;
        }

        .bulk-actions.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .analysis-counter {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .counter-item {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            margin: 0.5rem;
            transition: transform 0.3s ease;
        }

        .counter-item:hover {
            transform: translateY(-5px);
        }

        .counter-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .counter-label {
            font-size: 1rem;
            color: #555;
            font-weight: 600;
        }

        .history-item {
            background: white;
            border-radius: 20px;
            margin-bottom: 2rem;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
            cursor: pointer;
        }

        .history-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            transition: all 0.3s ease;
        }

        .history-item.good::before { background: linear-gradient(180deg, var(--success-color), #20c997); }
        .history-item.warning::before { background: linear-gradient(180deg, var(--accent-color), #ffcd39); }
        .history-item.danger::before { background: linear-gradient(180deg, var(--danger-color), #ff6b6b); }
        .history-item.pest-detection::before { background: linear-gradient(180deg, var(--info-color), #17a2b8); }

        .history-item:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .history-item:hover::before {
            width: 10px;
        }

        .item-header {
            padding: 2rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .item-content {
            padding: 2rem;
        }

        .health-summary, .pest-summary {
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }

        .health-summary {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border: 1px solid rgba(40, 167, 69, 0.2);
        }

        .pest-summary {
            background: linear-gradient(135deg, #e3f2fd 0%, #f0f8ff 100%);
            border: 1px solid rgba(13, 202, 240, 0.2);
        }

        .health-item, .pest-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }

        .health-item:hover, .pest-item:hover {
            transform: translateX(10px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .health-item.healthy-item { border-left-color: var(--success-color); }
        .health-item.diseased-item { border-left-color: var(--danger-color); }
        .pest-item.no-pest-item { border-left-color: var(--success-color); }
        .pest-item.pest-found-item { border-left-color: var(--danger-color); }
        .pest-item.high-risk-item { border-left-color: var(--accent-color); }
        .pest-item.uncertain-item { border-left-color: var(--secondary-color); }

        .health-status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 2rem;
            border-radius: 50px;
            font-weight: bold;
            font-size: 1rem;
            margin: 1rem 0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .health-status-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .health-status-badge:hover::before {
            left: 100%;
        }

        .health-status-badge.good {
            background: linear-gradient(45deg, var(--success-color), #20c997);
            color: white;
        }

        .health-status-badge.moderate {
            background: linear-gradient(45deg, var(--accent-color), #ffcd39);
            color: #212529;
        }

        .health-status-badge.poor {
            background: linear-gradient(45deg, var(--danger-color), #ff6b6b);
            color: white;
        }

        .health-status-badge.pest-detection {
            background: linear-gradient(45deg, var(--info-color), #17a2b8);
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-sm::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .btn-sm:hover::before {
            left: 100%;
        }

        .btn-sm:hover {
            transform: translateY(-2px);
        }

        .analysis-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 1rem;
            cursor: pointer;
            transform: scale(1.2);
        }

        .select-all-checkbox {
            width: 18px;
            height: 18px;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        .empty-state-icon {
            font-size: 6rem;
            color: #dee2e6;
            margin-bottom: 2rem;
        }

        .disease-details {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            border: 1px solid rgba(220, 53, 69, 0.15);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
        }

        .disease-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .disease-item:last-child {
            border-bottom: none;
        }

        .disease-count {
            background: linear-gradient(45deg, var(--danger-color), #ff6b6b);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }

        .analysis-date {
            font-size: 0.95rem;
            color: #6c757d;
            font-style: italic;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .main-container {
                padding: 0 10px;
            }
            
            .app-header h1 {
                font-size: 1.75rem;
            }
            
            .control-panel {
                padding: 1rem;
            }
            
            .filter-buttons .btn {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
            
            .history-item:hover {
                transform: none;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 0.25rem;
            }

            .counter-number {
                font-size: 2rem;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">
                    <i class="bi bi-clock-history me-3"></i> Analysis History
                </h1>
                <div>
                    <a href="/detector/" class="btn btn-outline-light me-2">
                        <i class="bi bi-arrow-left me-1"></i> Back
                    </a>
                    <a href="/tree-analysis/" class="btn btn-outline-light me-2">
                        <i class="bi bi-plus-lg me-1"></i> New Tree Analysis
                    </a>
                    <a href="/pest-detector/" class="btn btn-outline-light">
                        <i class="bi bi-bug me-1"></i> Pest Detection
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-4 main-container">
        <div class="row">
            <div class="col-12">
                <!-- Control Panel -->
                <div class="control-panel">
                    <!-- Filter Section -->
                    <div class="filter-section">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <div class="btn-group filter-buttons" role="group">
                                <button type="button" class="btn btn-outline-light active" id="filter-all" onclick="filterAnalyses('all')">
                                    <i class="bi bi-list me-1"></i> All Analyses
                                </button>
                                <button type="button" class="btn btn-outline-light" id="filter-tree" onclick="filterAnalyses('tree')">
                                    <i class="bi bi-tree me-1"></i> Tree Analysis
                                </button>
                                <button type="button" class="btn btn-outline-light" id="filter-pest" onclick="filterAnalyses('pest')">
                                    <i class="bi bi-bug me-1"></i> Pest Detection
                                </button>
                            </div>
                            <div class="d-flex align-items-center text-white">
                                <input type="checkbox" class="select-all-checkbox me-2" id="select-all" onchange="toggleSelectAll()">
                                <label for="select-all" class="mb-0 fw-bold">Select All</label>
                            </div>
                        </div>
                    </div>

                    <!-- Bulk Actions -->
                    <div class="bulk-actions" id="bulk-actions">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <div class="text-white fw-bold">
                                <i class="bi bi-check-square me-2"></i>
                                <span id="selected-count">0</span> items selected
                            </div>
                            <div>
                                <button class="btn btn-outline-light me-2" onclick="exportSelected()">
                                    <i class="bi bi-download me-1"></i> Export Selected
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteSelected()">
                                    <i class="bi bi-trash me-1"></i> Delete Selected
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Analysis Counter -->
                    <div class="analysis-counter">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="counter-item">
                                    <div class="counter-number" id="total-count">0</div>
                                    <div class="counter-label">Total Analyses</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="counter-item">
                                    <div class="counter-number" id="tree-count">0</div>
                                    <div class="counter-label">Tree Analyses</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="counter-item">
                                    <div class="counter-number" id="pest-count">0</div>
                                    <div class="counter-label">Pest Detections</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History Items Container -->
                <div id="analysis-list">
                    {% if analyses %}
                        {% for analysis in analyses %}
                            {% if analysis.type == 'tree_analysis' %}
                                <!-- Tree Analysis Item -->
                                <div class="history-item 
                                      {% if analysis.overall_health >= 80 %}good{% elif analysis.overall_health >= 50 %}warning{% else %}danger{% endif %}"
                                     data-analysis-id="{{ analysis.id }}" data-type="tree">
                                    <div class="item-header">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="d-flex align-items-start">
                                                <input type="checkbox" class="analysis-checkbox" 
                                                       data-id="{{ analysis.id }}" data-type="tree" 
                                                       onchange="updateBulkActions()" onclick="event.stopPropagation()">
                                                <div>
                                                    <h4 class="mb-2 text-primary">
                                                        <i class="bi bi-tree me-2"></i>{{ analysis.name }}
                                                    </h4>
                                                    <div class="analysis-date">
                                                        <i class="bi bi-calendar3 me-1"></i>
                                                        {{ analysis.completed_at|date:"F d, Y" }} at {{ analysis.completed_at|date:"H:i" }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="action-buttons" onclick="event.stopPropagation();">
                                                <button class="btn btn-sm btn-outline-primary" onclick="viewAnalysisDetail({{ analysis.id }})" title="View Details">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-success" onclick="exportAnalysis({{ analysis.id }})" title="Export Analysis">
                                                    <i class="bi bi-download"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteAnalysis({{ analysis.id }})" title="Delete Analysis">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="item-content" onclick="viewAnalysisDetail({{ analysis.id }})">
                                        <!-- Health Summary -->
                                        <div class="health-summary">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <div class="health-item healthy-item">
                                                        <span>
                                                            <i class="bi bi-check-circle-fill text-success me-2"></i>
                                                            <strong>Healthy Leaves</strong>
                                                        </span>
                                                        <span class="fw-bold">{{ analysis.healthy_count }} ({{ analysis.healthy_percentage|floatformat:1 }}%)</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="health-item diseased-item">
                                                        <span>
                                                            <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>
                                                            <strong>Diseased Leaves</strong>
                                                        </span>
                                                        <span class="fw-bold">{{ analysis.diseased_count }} ({{ analysis.diseased_percentage|floatformat:1 }}%)</span>
                                                    </div>
                                                </div>
                                            </div>
                                            {% if analysis.diseased_count > 0 %}
                                            <div class="disease-details">
                                                <h6 class="text-danger fw-bold mb-3">
                                                    <i class="bi bi-bug me-2"></i>Disease Breakdown
                                                </h6>
                                                {% if analysis.dried_leaf_count > 0 %}
                                                <div class="disease-item">
                                                    <span class="disease-name">
                                                        <i class="bi bi-leaf text-warning me-2"></i>
                                                        <strong>Dried Leaf</strong>
                                                    </span>
                                                    <span class="disease-count">{{ analysis.dried_leaf_count }}</span>
                                                </div>
                                                {% endif %}
                                                {% if analysis.powdery_mildew_count > 0 %}
                                                <div class="disease-item">
                                                    <span class="disease-name">
                                                        <i class="bi bi-cloud-haze text-info me-2"></i>
                                                        <strong>Powdery Mildew</strong>
                                                    </span>
                                                    <span class="disease-count">{{ analysis.powdery_mildew_count }}</span>
                                                </div>
                                                {% endif %}
                                                {% if analysis.leaf_rust_count > 0 %}
                                                <div class="disease-item">
                                                    <span class="disease-name">
                                                        <i class="bi bi-bug text-danger me-2"></i>
                                                        <strong>Leaf Rust</strong>
                                                    </span>
                                                    <span class="disease-count">{{ analysis.leaf_rust_count }}</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                            <div class="text-center mt-3">
                                                <div class="health-status-badge 
                                                      {% if analysis.overall_health >= 80 %}good{% elif analysis.overall_health >= 50 %}moderate{% else %}poor{% endif %}">
                                                    <i class="bi {% if analysis.overall_health >= 80 %}bi-check-circle-fill{% elif analysis.overall_health >= 50 %}bi-exclamation-triangle-fill{% else %}bi-x-circle-fill{% endif %} me-2"></i>
                                                    {% if analysis.overall_health >= 80 %}Excellent Health{% elif analysis.overall_health >= 50 %}Moderate Health{% else %}Poor Health{% endif %}
                                                    ({{ analysis.overall_health|floatformat:1 }}%)
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <!-- Pest Detection Item -->
                                <div class="history-item pest-detection"
                                     data-analysis-id="{{ analysis.id }}" data-type="pest">
                                    <div class="item-header">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="d-flex align-items-start">
                                                <input type="checkbox" class="analysis-checkbox" 
                                                       data-id="{{ analysis.id }}" data-type="pest" 
                                                       onchange="updateBulkActions()" onclick="event.stopPropagation()">
                                                <div>
                                                    <h4 class="mb-2 text-info">
                                                        <i class="bi bi-bug-fill me-2"></i>{{ analysis.name }}
                                                    </h4>
                                                    <div class="analysis-date">
                                                        <i class="bi bi-calendar3 me-1"></i>
                                                        {{ analysis.completed_at|date:"F d, Y" }} at {{ analysis.completed_at|date:"H:i" }}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="action-buttons" onclick="event.stopPropagation();">
                                                <button class="btn btn-sm btn-outline-primary" onclick="viewPestDetail({{ analysis.id }})" title="View Details">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-info" onclick="exportPestSession({{ analysis.id }})" title="Export Session">
                                                    <i class="bi bi-download"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deletePestSession({{ analysis.id }})" title="Delete Session">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="item-content" onclick="viewPestDetail({{ analysis.id }})">
                                        <!-- Pest Summary -->
                                        <div class="pest-summary">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <div class="pest-item no-pest-item">
                                                        <span>
                                                            <i class="bi bi-shield-check text-success me-2"></i>
                                                            <strong>No Pests Found</strong>
                                                        </span>
                                                        <span class="fw-bold">{{ analysis.no_pest_count }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="pest-item pest-found-item">
                                                        <span>
                                                            <i class="bi bi-bug text-danger me-2"></i>
                                                            <strong>Pests Detected</strong>
                                                        </span>
                                                        <span class="fw-bold">{{ analysis.pest_count }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <div class="pest-item high-risk-item">
                                                        <span>
                                                            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                                                            <strong>High Risk</strong>
                                                        </span>
                                                        <span class="fw-bold">{{ analysis.high_risk_count }}</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="pest-item uncertain-item">
                                                        <span>
                                                            <i class="bi bi-question-circle text-secondary me-2"></i>
                                                            <strong>Uncertain</strong>
                                                        </span>
                                                        <span class="fw-bold">{{ analysis.uncertain_count }}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="text-center mt-3">
                                                <div class="health-status-badge pest-detection">
                                                    <i class="bi bi-clipboard-data me-2"></i>
                                                    {{ analysis.total_processed }} Images Processed
                                                    ({{ analysis.avg_confidence|floatformat:1 }}% Avg Confidence)
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <!-- Empty state -->
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="bi bi-clipboard-x"></i>
                            </div>
                            <h3 class="text-muted mb-3">No Analysis History</h3>
                            <p class="text-muted mb-4">You haven't completed any analyses yet.</p>
                            <div class="d-flex gap-2 justify-content-center flex-wrap">
                                <a href="/tree-analysis/" class="btn btn-success btn-lg">
                                    <i class="bi bi-tree me-2"></i> Start Tree Analysis
                                </a>
                                <a href="/pest-detector/" class="btn btn-info btn-lg">
                                    <i class="bi bi-bug me-2"></i> Start Pest Detection
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Detail Modal -->
    <div class="modal fade" id="analysisDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl analysis-detail-modal">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="analysisDetailModalLabel">
                        <i class="bi bi-clipboard-data me-2"></i>Analysis Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body analysis-detail-content" id="analysisDetailContent">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-1"></i> Close
                    </button>
                    <button type="button" class="btn btn-primary" id="exportSingleBtn">
                        <i class="bi bi-download me-1"></i> Export This Analysis
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Pest Detail Modal -->
    <div class="modal fade" id="pestDetailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title" id="pestDetailModalLabel">
                        <i class="bi bi-bug-fill me-2"></i>Pest Detection Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="pestDetailContent">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-1"></i> Close
                    </button>
                    <button type="button" class="btn btn-info" id="exportPestBtn">
                        <i class="bi bi-download me-1"></i> Export This Session
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Confirm Deletion
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p id="delete-confirm-message">Are you sure you want to delete this analysis? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-btn">
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentAnalysisId = null;
        let currentAnalysisType = null;

        // Get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Multi-select functionality
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all');
            const checkboxes = document.querySelectorAll('.analysis-checkbox:not([style*="display: none"])');
            
            checkboxes.forEach(checkbox => {
                if (checkbox.closest('.history-item').style.display !== 'none') {
                    checkbox.checked = selectAllCheckbox.checked;
                }
            });
            
            updateBulkActions();
        }

        function updateBulkActions() {
            const checkedBoxes = document.querySelectorAll('.analysis-checkbox:checked');
            const bulkActions = document.getElementById('bulk-actions');
            const selectedCount = document.getElementById('selected-count');
            
            selectedCount.textContent = checkedBoxes.length;
            
            if (checkedBoxes.length > 0) {
                bulkActions.classList.add('show');
            } else {
                bulkActions.classList.remove('show');
            }
            
            // Update select all checkbox state
            const allVisibleCheckboxes = document.querySelectorAll('.analysis-checkbox:not([style*="display: none"])');
            const visibleCheckboxes = Array.from(allVisibleCheckboxes).filter(cb => 
                cb.closest('.history-item').style.display !== 'none'
            );
            const selectAllCheckbox = document.getElementById('select-all');
            
            if (visibleCheckboxes.length === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (checkedBoxes.length === visibleCheckboxes.length) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else if (checkedBoxes.length > 0) {
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            }
        }

        // Export selected items
        async function exportSelected() {
            const checkedBoxes = document.querySelectorAll('.analysis-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('Please select items to export.');
                return;
            }

            const treeIds = [];
            const pestIds = [];
            
            checkedBoxes.forEach(checkbox => {
                const id = checkbox.getAttribute('data-id');
                const type = checkbox.getAttribute('data-type');
                
                if (type === 'tree') {
                    treeIds.push(id);
                } else if (type === 'pest') {
                    pestIds.push(id);
                }
            });

            // Export tree analyses
            if (treeIds.length > 0) {
                window.location.href = '/analyses/export/?ids=' + treeIds.join(',');
            }

            // Export pest sessions (implement multiple export)
            if (pestIds.length > 0) {
                for (const id of pestIds) {
                    exportPestSession(id);
                }
            }
        }

        // Delete selected items
        async function deleteSelected() {
            const checkedBoxes = document.querySelectorAll('.analysis-checkbox:checked');
            if (checkedBoxes.length === 0) {
                alert('Please select items to delete.');
                return;
            }

            const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            document.getElementById('delete-confirm-message').textContent = 
                `Are you sure you want to delete ${checkedBoxes.length} selected items? This action cannot be undone.`;
            
            document.getElementById('confirm-delete-btn').onclick = async function() {
                try {
                    const treeIds = [];
                    const pestIds = [];
                    
                    checkedBoxes.forEach(checkbox => {
                        const id = checkbox.getAttribute('data-id');
                        const type = checkbox.getAttribute('data-type');
                        
                        if (type === 'tree') {
                            treeIds.push(parseInt(id));
                        } else if (type === 'pest') {
                            pestIds.push(parseInt(id));
                        }
                    });

                    // Delete tree analyses
                    if (treeIds.length > 0) {
                        const treeResponse = await fetch('/analyses/delete/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCookie('csrftoken')
                            },
                            body: JSON.stringify({ ids: treeIds })
                        });

                        if (!treeResponse.ok) {
                            throw new Error('Failed to delete tree analyses');
                        }
                    }

                    // Delete pest sessions
                    for (const id of pestIds) {
                        const pestResponse = await fetch(`/pest-session/${id}/delete/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': getCookie('csrftoken')
                            }
                        });

                        if (!pestResponse.ok) {
                            throw new Error(`Failed to delete pest session ${id}`);
                        }
                    }

                    deleteConfirmModal.hide();
                    location.reload();
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error deleting selected items: ' + error.message);
                }
            };

            deleteConfirmModal.show();
        }

        // Filter functionality
        let currentFilter = 'all';

        function filterAnalyses(type) {
            currentFilter = type;
            
            // Update button states
            document.querySelectorAll('.filter-buttons .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`filter-${type}`).classList.add('active');
            
            // Show/hide analyses based on type
            const analyses = document.querySelectorAll('.history-item');
            let visibleCount = 0;
            
            analyses.forEach(item => {
                const itemType = item.getAttribute('data-type');
                if (type === 'all' || itemType === type) {
                    item.style.display = 'block';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Clear all selections when filtering
            document.querySelectorAll('.analysis-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('select-all').checked = false;
            updateBulkActions();
            
            // Update empty state
            const analysisList = document.getElementById('analysis-list');
            const emptyState = analysisList.querySelector('.empty-state');
            
            if (visibleCount === 0 && !emptyState) {
                showEmptyState(type);
            } else if (visibleCount > 0 && emptyState) {
                emptyState.remove();
            }
        }

        function showEmptyState(type) {
            const analysisList = document.getElementById('analysis-list');
            const emptyStateHtml = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="bi ${type === 'tree' ? 'bi-tree' : type === 'pest' ? 'bi-bug' : 'bi-clipboard-x'}"></i>
                    </div>
                    <h3 class="text-muted mb-3">No ${type === 'tree' ? 'Tree Analyses' : type === 'pest' ? 'Pest Detections' : 'Analyses'} Found</h3>
                    <p class="text-muted mb-4">
                        ${type === 'tree' ? 'You haven\'t completed any tree analyses yet.' : 
                          type === 'pest' ? 'You haven\'t completed any pest detections yet.' : 
                          'You haven\'t completed any analyses yet.'}
                    </p>
                    <div class="d-flex gap-2 justify-content-center flex-wrap">
                        ${type !== 'pest' ? '<a href="/tree-analysis/" class="btn btn-success btn-lg"><i class="bi bi-tree me-2"></i> Start Tree Analysis</a>' : ''}
                        ${type !== 'tree' ? '<a href="/pest-detector/" class="btn btn-info btn-lg"><i class="bi bi-bug me-2"></i> Start Pest Detection</a>' : ''}
                    </div>
                </div>
            `;
            analysisList.innerHTML = emptyStateHtml;
        }

        // Update counters on page load
        function updateCounters() {
            const allAnalyses = document.querySelectorAll('.history-item');
            const treeAnalyses = document.querySelectorAll('.history-item[data-type="tree"]');
            const pestAnalyses = document.querySelectorAll('.history-item[data-type="pest"]');
            
            document.getElementById('total-count').textContent = allAnalyses.length;
            document.getElementById('tree-count').textContent = treeAnalyses.length;
            document.getElementById('pest-count').textContent = pestAnalyses.length;
        }

        // View tree analysis detail in modal
        async function viewAnalysisDetail(analysisId) {
            try {
                currentAnalysisId = analysisId;
                currentAnalysisType = 'tree';
                
                // Show loading state
                const modalContent = document.getElementById('analysisDetailContent');
                modalContent.innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted">Loading analysis details...</p>
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('analysisDetailModal'));
                modal.show();
                
                // Fetch detailed analysis data
                const response = await fetch(`/analysis/${analysisId}/detail/`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const analysisData = await response.json();
                
                if (!analysisData.success) {
                    throw new Error(analysisData.error || 'Failed to load analysis details');
                }

                const analysis = analysisData.analysis;

                modalContent.innerHTML = `
                    <div class="text-center mb-4">
                        <h3 class="text-primary">
                            <i class="bi bi-tree me-2"></i>${analysis.name}
                        </h3>
                        <p class="text-muted">
                            <i class="bi bi-calendar3 me-1"></i> ${new Date(analysis.completed_at).toLocaleDateString('en-US', {
                                year: 'numeric',
                                month: 'long', 
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            })}
                        </p>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="alert ${analysis.overall_health >= 80 ? 'alert-success' : analysis.overall_health >= 50 ? 'alert-warning' : 'alert-danger'}">
                                <h6 class="alert-heading">
                                    <i class="bi ${analysis.overall_health >= 80 ? 'bi-check-circle-fill' : analysis.overall_health >= 50 ? 'bi-exclamation-triangle-fill' : 'bi-x-circle-fill'} me-2"></i>
                                    Health Assessment
                                </h6>
                                <p class="mb-0">
                                    ${analysis.overall_health >= 80 ? 'Tree is in excellent health with minimal disease presence.' :
                                      analysis.overall_health >= 50 ? 'Tree shows moderate health concerns. Monitor closely.' :
                                      'Tree health is poor. Immediate attention required.'}
                                </p>
                                <hr>
                                <p class="mb-0"><strong>Overall Health: ${analysis.overall_health.toFixed(1)}%</strong></p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <canvas id="detailChart" width="300" height="300"></canvas>
                        </div>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-success bg-opacity-10 rounded">
                                <h4 class="text-success">${analysis.healthy_count}</h4>
                                <p class="mb-0">Healthy (${analysis.healthy_percentage.toFixed(1)}%)</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-warning bg-opacity-10 rounded">
                                <h4 class="text-warning">${analysis.dried_leaf_count}</h4>
                                <p class="mb-0">Dried Leaf (${analysis.dried_leaf_percentage.toFixed(1)}%)</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-info bg-opacity-10 rounded">
                                <h4 class="text-info">${analysis.powdery_mildew_count}</h4>
                                <p class="mb-0">Powdery Mildew (${analysis.powdery_mildew_percentage.toFixed(1)}%)</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center p-3 bg-danger bg-opacity-10 rounded">
                                <h4 class="text-danger">${analysis.leaf_rust_count}</h4>
                                <p class="mb-0">Leaf Rust (${analysis.leaf_rust_percentage.toFixed(1)}%)</p>
                            </div>
                        </div>
                    </div>
                `;

                document.getElementById('analysisDetailModalLabel').textContent = `Analysis: ${analysis.name}`;

                // Create chart
                setTimeout(() => {
                    const ctx = document.getElementById('detailChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Healthy', 'Dried Leaf', 'Powdery Mildew', 'Leaf Rust'],
                            datasets: [{
                                data: [analysis.healthy_count, analysis.dried_leaf_count, analysis.powdery_mildew_count, analysis.leaf_rust_count],
                                backgroundColor: ['#28a745', '#ffc107', '#0dcaf0', '#dc3545'],
                                borderWidth: 0,
                                hoverOffset: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: {
                                   position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        usePointStyle: true
                                    }
                                }
                            }
                        }
                    });
                }, 100);

            } catch (error) {
                console.error('Error loading analysis detail:', error);
                modalContent.innerHTML = `
                    <div class="text-center py-5">
                        <div class="text-danger mb-3">
                            <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                        </div>
                        <h5 class="text-danger">Error Loading Analysis</h5>
                        <p class="text-muted">${error.message}</p>
                        <button class="btn btn-primary" onclick="viewAnalysisDetail(${analysisId})">
                            <i class="bi bi-arrow-clockwise me-1"></i> Try Again
                        </button>
                    </div>
                `;
            }
        }

        // View pest detection detail in modal
        async function viewPestDetail(sessionId) {
            try {
                currentAnalysisId = sessionId;
                currentAnalysisType = 'pest';
                
                const modalContent = document.getElementById('pestDetailContent');
                modalContent.innerHTML = `
                    <div class="text-center py-5">
                        <div class="spinner-border text-info mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted">Loading pest detection details...</p>
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('pestDetailModal'));
                modal.show();
                
                // Show pest session details
                modalContent.innerHTML = `
                    <div class="text-center mb-4">
                        <h3 class="text-info">
                            <i class="bi bi-bug-fill me-2"></i>Pest Detection Session
                        </h3>
                        <p class="text-muted">Session ID: ${sessionId}</p>
                    </div>
                    <div class="alert alert-info">
                        <h6 class="alert-heading">
                            <i class="bi bi-info-circle me-2"></i>Session Summary
                        </h6>
                        <p class="mb-0">
                            This pest detection session has been completed successfully. 
                            You can export the detailed results using the export button below.
                        </p>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading pest detail:', error);
                modalContent.innerHTML = `
                    <div class="text-center py-5">
                        <div class="text-danger mb-3">
                            <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
                        </div>
                        <h5 class="text-danger">Error Loading Pest Details</h5>
                        <p class="text-muted">${error.message}</p>
                    </div>
                `;
            }
        }

        // Export single analysis as PDF
        function exportAnalysis(analysisId) {
            window.location.href = `/analysis/${analysisId}/export/pdf/`;
        }

        // Export pest session as CSV
        function exportPestSession(sessionId) {
            window.location.href = `/pest-session/${sessionId}/export/csv/`;
        }

        // Export single analysis from modal
        document.getElementById('exportSingleBtn').addEventListener('click', () => {
            if (currentAnalysisId && currentAnalysisType === 'tree') {
                exportAnalysis(currentAnalysisId);
            }
        });

        // Export pest session from modal
        document.getElementById('exportPestBtn').addEventListener('click', () => {
            if (currentAnalysisId && currentAnalysisType === 'pest') {
                exportPestSession(currentAnalysisId);
            }
        });

        // Delete single analysis
        async function deleteAnalysis(analysisId) {
            const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            document.getElementById('delete-confirm-message').textContent = 'Are you sure you want to delete this tree analysis? This action cannot be undone.';
            
            document.getElementById('confirm-delete-btn').onclick = async function() {
                try {
                    const response = await fetch(`/analysis/${analysisId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    });

                    if (response.ok) {
                        deleteConfirmModal.hide();
                        location.reload();
                    } else {
                        alert('Error deleting analysis.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error deleting analysis.');
                }
            };

            deleteConfirmModal.show();
        }

        // Delete pest session
        async function deletePestSession(sessionId) {
            const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            document.getElementById('delete-confirm-message').textContent = 'Are you sure you want to delete this pest detection session? This action cannot be undone.';
            
            document.getElementById('confirm-delete-btn').onclick = async function() {
                try {
                    const response = await fetch(`/pest-session/${sessionId}/delete/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    });

                    if (response.ok) {
                        deleteConfirmModal.hide();
                        location.reload();
                    } else {
                        alert('Error deleting pest session.');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error deleting pest session.');
                }
            };

            deleteConfirmModal.show();
        }

        // Call updateCounters when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateCounters();
        });
    </script>
</body>
</html>
